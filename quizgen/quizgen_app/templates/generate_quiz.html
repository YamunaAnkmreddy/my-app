{% extends 'base.html' %}

{% block title %}Generate AI Quiz - Quiz Platform{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h3><i class="fas fa-magic"></i> Generate Your AI Quiz</h3>
                    <p class="mb-0">Customize your quiz preferences below</p>
                </div>
                <div class="card-body">
                    <form method="post" id="quiz-form">
                        {% csrf_token %}
                        
                        <!-- Category Selection -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.category.id_for_label }}" class="form-label">
                                    <i class="fas fa-folder"></i> Category <span class="text-danger">*</span>
                                </label>
                                {{ form.category }}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.subcategory.id_for_label }}" class="form-label">
                                    <i class="fas fa-folder-open"></i> Subcategory
                                </label>
                                {{ form.subcategory }}
                                <small class="form-text text-muted">Optional - Select a specific topic</small>
                            </div>
                        </div>

                        <!-- Difficulty and Questions -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.difficulty.id_for_label }}" class="form-label">
                                    <i class="fas fa-signal"></i> Difficulty Level
                                </label>
                                {{ form.difficulty }}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.questions_count.id_for_label }}" class="form-label">
                                    <i class="fas fa-question-circle"></i> Number of Questions
                                </label>
                                {{ form.questions_count }}
                                <small class="form-text text-muted">3-20 questions</small>
                            </div>
                        </div>

                        <!-- Time Limit -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.time_limit.id_for_label }}" class="form-label">
                                    <i class="fas fa-clock"></i> Time Limit (minutes)
                                </label>
                                {{ form.time_limit }}
                                <small class="form-text text-muted">{{ form.time_limit.help_text }}</small>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="p-3 bg-light rounded w-100">
                                    <h6><i class="fas fa-calculator"></i> Time Per Question</h6>
                                    <p class="mb-0 text-muted" id="time-per-question">2 minutes per question</p>
                                </div>
                            </div>
                        </div>

                        <!-- Preview Box -->
                        <div class="alert alert-info">
                            <h6><i class="fas fa-eye"></i> Quiz Preview</h6>
                            <div id="quiz-preview">
                                <p><strong>Category:</strong> <span id="preview-category">Not selected</span></p>
                                <p><strong>Subcategory:</strong> <span id="preview-subcategory">None</span></p>
                                <p><strong>Difficulty:</strong> <span id="preview-difficulty">Easy</span></p>
                                <p><strong>Questions:</strong> <span id="preview-questions">5</span></p>
                                <p><strong>Time Limit:</strong> <span id="preview-time">10</span> minutes</p>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-success btn-lg" id="generate-btn">
                                <i class="fas fa-magic"></i> Generate AI Quiz
                                <span class="spinner-border spinner-border-sm ms-2 d-none" id="loading-spinner"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- FAQ -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-question"></i> Frequently Asked Questions</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="faqAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                    How are questions generated?
                                </button>
                            </h2>
                            <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    Our AI uses advanced language models to generate unique, relevant questions based on your selected category and difficulty level.
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                    Can I retake the same quiz?
                                </button>
                            </h2>
                            <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    Yes! Each time you generate a quiz, new questions are created, so you can practice the same topic multiple times with different questions.
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                    What happens if I run out of time?
                                </button>
                            </h2>
                            <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    If the time limit expires, your quiz will be automatically submitted with your current answers. Unanswered questions will be marked as incorrect.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dynamic subcategory loading
    const categorySelect = document.getElementById('id_category');
    const subcategorySelect = document.getElementById('id_subcategory');
    
    categorySelect.addEventListener('change', function() {
        const categoryId = this.value;
        subcategorySelect.innerHTML = '<option value="">---------</option>';
        
        if (categoryId) {
            fetch(`/api/subcategories/?category_id=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory.id;
                        option.textContent = subcategory.name;
                        subcategorySelect.appendChild(option);
                    });
                });
        }
        updatePreview();
    });
    
    // Update preview
    function updatePreview() {
        const category = categorySelect.options[categorySelect.selectedIndex]?.text || 'Not selected';
        const subcategory = subcategorySelect.options[subcategorySelect.selectedIndex]?.text || 'None';
        const difficulty = document.getElementById('id_difficulty').value;
        const questions = document.getElementById('id_questions_count').value;
        const timeLimit = document.getElementById('id_time_limit').value;
        
        document.getElementById('preview-category').textContent = category;
        document.getElementById('preview-subcategory').textContent = subcategory === '---------' ? 'None' : subcategory;
        document.getElementById('preview-difficulty').textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
        document.getElementById('preview-questions').textContent = questions;
        document.getElementById('preview-time').textContent = timeLimit;
        
        // Calculate time per question
        if (questions && timeLimit) {
            const timePerQuestion = Math.round((timeLimit / questions) * 100) / 100;
            document.getElementById('time-per-question').textContent = `${timePerQuestion} minutes per question`;
        }
    }
    
    // Add event listeners for all form fields
    document.querySelectorAll('#quiz-form select, #quiz-form input').forEach(field => {
        field.addEventListener('change', updatePreview);
    });
    
    // Form submission
    document.getElementById('quiz-form').addEventListener('submit', function() {
        const generateBtn = document.getElementById('generate-btn');
        const spinner = document.getElementById('loading-spinner');
        
        generateBtn.disabled = true;
        spinner.classList.remove('d-none');
        generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generating Quiz... <span class="spinner-border spinner-border-sm ms-2"></span>';
    });
    
    // Initialize preview
    updatePreview();
    
    // Pre-select category from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const categoryParam = urlParams.get('category');
    if (categoryParam) {
        categorySelect.value = categoryParam;
        categorySelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}